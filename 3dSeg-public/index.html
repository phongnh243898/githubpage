<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><title>PCD Professional Viewer</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; height: 100vh; background: #111; color: #fff; font-family: sans-serif; font-size: 13px; overflow: hidden; position: relative; }
    #layout { position: relative; display: flex; height: 100%; }
    #viewWrap { flex: 1; position: relative; background: #111; }
    #render3d { position: absolute; inset: 0; }

    #sidebarRight {
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 320px;
      padding: 15px;
      background: #1a1a1a;
      border-left: 1px solid #333;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 2600;
    }
    #sidebarRight.open { transform: translateX(0); }

    #sidebarRight h3 { color: #00aaff; border-bottom: 1px solid #333; font-size: 13px; margin-top: 0; }
    #sidebarRight input, #sidebarRight select, #sidebarRight button { width: 100%; margin-bottom: 10px; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: #eee; font-size: 12px; }
    #sidebarRight button:hover { background: #3a3a3a; cursor: pointer; }
    #sidebarRight label { display: block; margin-bottom: 4px; color: #aaa; }

    #toolbar { position: absolute; top: 10px; left: 10px; z-index: 2500; display: flex; gap: 5px; }
    #toolbar button { background: rgba(0,0,0,0.7); border: 1px solid #444; color: #fff; padding: 5px 10px; cursor: pointer; font-size: 12px; }
    #toolbar button:hover { background: #00aaff; }
    #toolbar button.active { background: #00aaff; border-color: #00eeff; }

    #video-overlay { position: absolute; bottom: 10px; right: 10px; width: 320px; height: 240px; background: #000; border: 1px solid #444; z-index: 2500; overflow: hidden; }
    #video-overlay video { width: 100%; height: 100%; object-fit: cover; }
    #video-overlay canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

    #status { position: absolute; bottom: 10px; left: 10px; z-index: 2500; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 3px; font-size: 12px; pointer-events: none; }
  </style>
</head>
<body>
  <div id="layout">
    <div id="viewWrap">
      <div id="render3d"></div>
      <div id="toolbar">
        <button id="drawPoly">Draw Polygon (N)</button>
        <button id="delPoly">Delete (Del)</button>
        <button id="import">Import JSON</button>
        <button id="export">Export JSON</button>
        <button id="settingBtn">Settings</button>
      </div>
      <div id="status">PCD: None | Polygons: 0</div>
    </div>

    <div id="sidebarRight">
      <h3>File PCD</h3>
      <input type="file" id="pcdInput" accept=".pcd" />
      
      <h3>Settings</h3>
      <label><input type="checkbox" id="flattenCheck" /> Flatten (Z=0)</label>
      
      <h3>Project</h3>
      <button id="saveProject">Save Annotations</button>
    </div>
  </div>

  <input type="file" id="jsonInput" accept=".json" style="display:none" />

  <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { PCDLoader } from 'three/addons/loaders/PCDLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { PolygonManager } from './js/helper_polygon.js';

    let scene, camera, renderer, controls, poly;
    let currentPcdName = "";
    const CATEGORY_LIST = [
        { id: 207733, name: 'undrivable' },
        { id: 207734, name: 'things' },
        { id: 207735, name: 'construction' },
        { id: 207736, name: 'uneven' }
    ];

    function init() {
      const container = document.getElementById('render3d');
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 0, 50);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      poly = new PolygonManager(scene, renderer);

      window.addEventListener('resize', onResize);
      setupEvents();
      animate();
    }

    function onResize() {
      const container = document.getElementById('render3d');
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    }

    function setupEvents() {
      document.getElementById('pcdInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        currentPcdName = file.name;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const loader = new PCDLoader();
          const points = loader.parse(ev.target.result);
          scene.children.filter(c => c.type === 'Points').forEach(p => scene.remove(p));
          scene.add(points);
          document.getElementById('status').innerText = `PCD: ${currentPcdName} | Polygons: ${poly.polygons.length}`;
        };
        reader.readAsArrayBuffer(file);
      };

      document.getElementById('drawPoly').onclick = () => poly.start();
      
      document.getElementById('import').onclick = () => document.getElementById('jsonInput').click();
      document.getElementById('jsonInput').onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
              try {
                  const data = JSON.parse(reader.result);
                  // SỬA CHÍNH: Truyền toàn bộ object JSON (gồm categories) vào manager
                  poly.loadFromAnnotations({
                      annotations: data.annotations || [],
                      categories: data.categories || []
                  });
              } catch (err) { console.error("Invalid JSON", err); }
          };
          reader.readAsText(file);
      };

      document.getElementById('export').onclick = () => {
          // SỬA CHÍNH: Lấy data chuẩn COCO từ manager (đã map Name -> ID)
          const data = poly.getAnnotations();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = currentPcdName ? currentPcdName.replace('.pcd', '.json') : 'export.json';
          a.click();
      };

      renderer.domElement.addEventListener('mousedown', (e) => {
          if (poly.isDrawing) {
              poly.addPoint(e, camera);
          } else {
              poly.handlePointerDown(e, camera);
          }
      });

      window.addEventListener('mousemove', (e) => poly.onDrag(e, camera));
      window.addEventListener('mouseup', () => poly.onDragEnd());

      window.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'n') poly.start();
        if (e.key === 'Enter') poly.finish();
        if (e.key === 'Delete') poly.deleteSelected();
        if (e.key === 'Tab') {
          e.preventDefault();
          poly.cycleCategory(e.shiftKey ? -1 : 1);
        }
      });
      
      document.getElementById('flattenCheck').onchange = (e) => poly.setFlatten(e.target.checked);
      document.getElementById('settingBtn').onclick = () => document.getElementById('sidebarRight').classList.toggle('open');
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    init();
  </script>
</body>
</html>
