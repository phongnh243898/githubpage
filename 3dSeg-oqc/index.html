<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><title>PCD Professional Viewer</title>
  <style>
    /* Giữ nguyên style mặc định của bạn */
  </style>
</head>
<body>
  <button id="settingBtn">⚙</button>
  <div id="layout">
    <div id="viewWrap">
      <div id="render3d"></div>
    </div>
    <div id="sidebarRight">
      <h3>Data</h3>
      <input type="file" id="pcdFile" accept=".pcd,.json" />
      <input type="file" id="videoFile" accept="video/*" />

      <h3>Shader Settings</h3>
      <label>Point Size (1-2)</label>
      <input type="range" id="size" min="1" max="10" step="0.1" value="1.5">

      <div class="group">
        <label>Color Mode</label>
        <select id="colorMode">
          <option value="default">Default</option>
          <option value="bw">B&W</option>
          <option value="height">Height Gradient</option>
          <option value="distance">Dist Gradient</option>
          <option value="reinhard">Reinhard (Linear RGB)</option>
        </select>
        <div id="gradOpts" style="display:none">
          <div class="row-2">
            <input type="number" id="min" value="0">
            <input type="number" id="max" value="5">
          </div>
          <div class="row-2" style="margin-top:6px;">
            <input type="color" id="c1" value="#0000ff">
            <input type="color" id="c2" value="#ff0000">
          </div>
          <label style="margin-top:6px;">Repeat / Mode</label>
          <div class="row-2">
            <input type="number" id="rep" value="1" step="0.1">
            <select id="mode"><option value="clamp">Clamp</option><option value="repeat">Repeat</option><option value="mirror">Mirror</option></select>
          </div>
        </div>
        <div id="reinhardOpts" style="display:none">
          <label>Reinhard Strength</label>
          <input type="number" id="reinhardStrength" value="1.0" min="0.01" max="10" step="0.01">
          <label>Exposure</label>
          <input type="number" id="reinhardExposure" value="1.0" min="0.01" max="10" step="0.01">
        </div>
      </div>

      <div class="group">
        <label>Filters (Min/Max)</label>
        <select id="fType">
          <option value="none">None</option>
          <option value="height">Height (Z)</option>
          <option value="distance">Distance</option>
        </select>
        <div id="filterOpts" style="display:none">
          <div class="row-2" style="margin-top:6px;">
            <input type="number" id="fMin" value="0">
            <input type="number" id="fMax" value="2">
          </div>
        </div>
      </div>

      <label class="inline-check"><input type="checkbox" id="oxy"> Project to OXY (2D)</label>
      <button id="apply" style="background:#007bff">APPLY ALL</button>
      <button id="export" style="background:#28a745">EXPORT POLYGONS</button>
    </div>
  </div>

  <!-- importmap & scripts của bạn giữ nguyên -->
  <script type="importmap"> 
  { 
    "imports": { 
      "three": "https://unpkg.com/three@0.161.0/build/three.module.js", 
      "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/",
      "./js":"./js"
    } 
  } </script>
  <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
      // ... (các đoạn import & khởi tạo như mặc định) ...

      // Khi thay đổi mode màu
      document.getElementById('colorMode').onchange = e => {
          document.getElementById('gradOpts').style.display = (e.target.value === 'height' || e.target.value === 'distance') ? 'block' : 'none';
          document.getElementById('reinhardOpts').style.display = (e.target.value === 'reinhard') ? 'block' : 'none';
      };

      function apply() {
          if(!points) return;
          const is2D = document.getElementById('oxy').checked;
          updatePCDShader(THREE, points, {
              pointSize: parseFloat(document.getElementById('size').value),
              colorMode: document.getElementById('colorMode').value,
              hZMin: parseFloat(document.getElementById('min').value), hZMax: parseFloat(document.getElementById('max').value),
              hStart: new THREE.Color(document.getElementById('c1').value), hEnd: new THREE.Color(document.getElementById('c2').value),
              hRepeat: parseFloat(document.getElementById('rep').value), hMode: document.getElementById('mode').value,
              dMin: parseFloat(document.getElementById('min').value), dMax: parseFloat(document.getElementById('max').value),
              dStart: new THREE.Color(document.getElementById('c1').value), dEnd: new THREE.Color(document.getElementById('c2').value),
              dRepeat: parseFloat(document.getElementById('rep').value), dMode: document.getElementById('mode').value,
              reinhardStrength: parseFloat(document.getElementById('reinhardStrength').value)||1.0,
              reinhardExposure: parseFloat(document.getElementById('reinhardExposure').value)||1.0,
              filterType: document.getElementById('fType').value,
              fMin: parseFloat(document.getElementById('fMin').value), fMax: parseFloat(document.getElementById('fMax').value),
              projectOXY: is2D
          });
      }
      document.getElementById('apply').onclick = apply;
      // ... (các mã khởi tạo và event khác giữ nguyên) ...
    });
  </script>
</body>
</html>
